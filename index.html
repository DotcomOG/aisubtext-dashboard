// scheduler.js - v1.0.0
// AIsubtext Autonomous Scheduler
// Runs the full loop automatically every 7 days
// Setup: node scheduler.js
// To run as background process: nohup node scheduler.js &

import { spawn } from "child_process";
import { writeFileSync, appendFileSync, existsSync } from "fs";
import * as dotenv from "dotenv";
dotenv.config();

const CONFIG = {
  intervalDays: 7,
  logFile: "./results/scheduler.log",
  scripts: ["monitor.js", "agent.js", "publisher.js"],
};

function log(msg) {
  const line = `[${new Date().toISOString()}] ${msg}`;
  console.log(line);
  appendFileSync(CONFIG.logFile, line + "\n");
}

function runScript(script) {
  return new Promise((resolve, reject) => {
    log(`â–¶ Starting ${script}...`);
    const proc = spawn("node", [script], { stdio: "pipe" });

    let output = "";
    proc.stdout.on("data", d => { output += d; process.stdout.write(d); });
    proc.stderr.on("data", d => { process.stderr.write(d); });

    proc.on("close", code => {
      if (code === 0) {
        log(`âœ… ${script} completed`);
        resolve(output);
      } else {
        log(`âŒ ${script} failed with code ${code}`);
        reject(new Error(`${script} exited with code ${code}`));
      }
    });
  });
}

async function runFullLoop() {
  log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  log("ğŸ¤– AIsubtext Autonomous Loop Starting");
  log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  for (const script of CONFIG.scripts) {
    try {
      await runScript(script);
      // Wait 5 seconds between scripts
      await new Promise(r => setTimeout(r, 5000));
    } catch (e) {
      log(`âŒ Loop aborted at ${script}: ${e.message}`);
      return;
    }
  }

  log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  log("âœ… Full loop complete â€” brand.aisubtext.ai updated");
  log(`â° Next run in ${CONFIG.intervalDays} days`);
  log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

async function start() {
  log("ğŸš€ AIsubtext Scheduler v1.0.0 started");
  log(`â° Running every ${CONFIG.intervalDays} days`);

  // Run immediately on start
  await runFullLoop();

  // Then schedule every 7 days
  const intervalMs = CONFIG.intervalDays * 24 * 60 * 60 * 1000;
  setInterval(runFullLoop, intervalMs);
}

start().catch(e => {
  log(`âŒ Scheduler crashed: ${e.message}`);
  process.exit(1);
});
